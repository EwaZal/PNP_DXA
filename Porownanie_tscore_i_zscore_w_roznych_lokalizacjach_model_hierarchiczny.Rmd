---
title: "PHPT DXA"
author: "Ewa Zalewska, Lukasz Cieszynski, Monika Berendt - Obolonczyk, Julia Tarnowska, Bartosz Zeglen, Renata Swiatkowska-Stodulska"
date:  "`r format(Sys.time(), '%e %b %Y, godz. %H:%M')`"
output:
  html_document:
    code_folding: hide
---

```{r, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

```{r setup, include=FALSE}

install.packages("Matrix")
install.packages("lme4")
install.packages("lmerTest")   # dopiero na końcu

library(Matrix)
library(dplyr)
library(purrr)
library(ggpubr)
library(tidyr)
library(scales)
library(rstatix)
library(ggplot2)
library(ggpubr)
library(ggsignif)
library(mice)
library(lme4)
library(lmerTest)   # wartości p dla lmer
library(emmeans)    # estymowane średnie i kontrasty
library(performance) # diagnostyka



plik_dane_do_analizy <- "PHPT.RDS"

if (file.exists(plik_dane_do_analizy)) {
  PHPT <- readRDS(plik_dane_do_analizy)
} else {
  stop(sprintf("Nie znaleziono pliku: `%s`. Uruchom notatnik przygotowujący zbiór danych!", plik_dane_do_analizy))
}


# Set global theme
theme_set(theme_classic2(base_size = 13))


PHPT_lme <- PHPT
```

# algorytm MICE 
``` {r}

kolumny_do_imputacji <- c("TBS", "Tscore_lumbar", "Tscore_femur_neck", "Tscore_radial", "BMD_neck")
dane_subset <- PHPT_lme[, kolumny_do_imputacji]

imputacja <- mice(dane_subset, m = 5, method = 'pmm', seed = 123)

dane_imputowane <- complete(imputacja, 1)

PHPT_lme[, kolumny_do_imputacji] <- dane_imputowane

summary(PHPT_lme)

```

``` {r}
score_lme <- bind_cols(
  PHPT_lme %>%
    select(LUMBAR = Tscore_lumbar, FEMUR = Tscore_femur_neck, RADIAL = Tscore_radial) %>%
    pivot_longer(cols = everything(), names_to = "site", values_to = "Tscore"),
  
  PHPT_lme %>%
    select(zscore_lumbar, zscore_femur_neck, zscore_radial) %>%
    pivot_longer(cols = everything(), names_to = NULL, values_to = "zscore") %>%
    select(zscore),
  
  PHPT_lme %>%
    select(group, sex, age, BMI, id) %>%
    slice(rep(1:n(), each = 3))  # powielamy wiersze x3, bo każdy pacjent ma 3 pomiary
)

```


``` {r}

score_lme$group <- factor(score_lme$group, levels = c("K","B"))  # K=kontrola, B=badani (PHPT)
score_lme$site  <- factor(score_lme$site,  levels = c("LUMBAR","FEMUR","RADIAL"))
score_lme$sex   <- factor(score_lme$sex)

# MODEL 1: random intercept dla pacjenta
m1 <- lmer(Tscore ~ site*group + age + sex + BMI + (1|id), data = score_lme, REML = TRUE)

summary(m1)        # estymaty i p-values (Satterthwaite)
anova(m1)          # testy F dla efektów stałych
check_model(m1)    # szybka diagnostyka reszt i dopasowania
```

``` {r}

# Estymowane średnie marginalne
emm <- emmeans(m1, ~ site*group)

# Różnice PHPT vs kontrola w każdej lokalizacji
pairs(emmeans(m1, ~ group | site), adjust = "holm")

# Różnice między lokalizacjami w każdej grupie
pairs(emmeans(m1, ~ site | group), adjust = "holm")
```

```{r}
# (1) Porządek poziomów (K/B i LUMBAR/FEMUR/RADIAL)
score_lme <- score_lme %>%
  mutate(
    group = factor(group, levels = c("K","B"), labels = c("control","PHPT")),
    site  = factor(site,  levels = c("LUMBAR","FEMUR","RADIAL"),
                          labels = c("lumbar","femoral neck","radius")),
    sex   = factor(sex)
  )

# (2) Kontrasty sum-to-zero do testów typu III
options(contrasts = c("contr.sum","contr.poly"))

# (3) Model mieszany (random intercept dla pacjenta)
m1 <- lmer(Tscore ~ site*group + age + sex + BMI + (1|id), data = score_lme, REML = TRUE)

# (4) Estymowane średnie marginalne (EMMs)
emm <- emmeans(m1, ~ site*group)
emm_df <- as.data.frame(emm)  # do wykresu: kolumny emmean, lower.CL, upper.CL

# (5) Kontrasty: PHPT vs kontrola w każdej lokalizacji (tabela do konsoli)
cat("\nPHPT vs control w poszczególnych lokalizacjach:\n")
contr_tbl <- pairs(emmeans(m1, ~ group | site), adjust = "holm")
print(contr_tbl)

# (6) Wykres EMM ±95% CI (punkty + errorbary + linie)
pd <- position_dodge(width = 0.35)

lme_plot <- ggplot(emm_df, aes(x = site, y = emmean, color = group, group = group)) +
  geom_point(size = 3, position = pd) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.14, position = pd) +
  geom_line(alpha = 0.7, position = pd) +
  labs(
    x = "Skeletal site",
    y = "T-score (estimated marginal means ±95% CI)",
    color = "Group",
    title = "T-score by skeletal site and group (mixed-effects model with a random intercept for patient)."
  ) +
  theme_minimal(base_size = 12)

ggsave("Lme_plot.jpg", plot = lme_plot, width = 9, height = 4, dpi = 300)

```

``` {r}

# MODEL 1: random intercept dla pacjenta
m2 <- lmer(zscore ~ site*group + age + sex + BMI + (1|id), data = score_lme, REML = TRUE)

summary(m2)        # estymaty i p-values (Satterthwaite)
anova(m2)          # testy F dla efektów stałych
check_model(m2)    # szybka diagnostyka reszt i dopasowania

# Estymowane średnie marginalne
emm2 <- emmeans(m2, ~ site*group)

# Różnice PHPT vs kontrola w każdej lokalizacji
pairs(emmeans(m2, ~ group | site), adjust = "holm")

# Różnice między lokalizacjami w każdej grupie
pairs(emmeans(m2, ~ site | group), adjust = "holm")
```

```{r}

# Kontrasty sum-to-zero do testów typu III
options(contrasts = c("contr.sum","contr.poly"))

# Model mieszany (random intercept dla pacjenta)
m2 <- lmer(zscore ~ site*group + age + sex + BMI + (1|id), data = score_lme, REML = TRUE)

# (4) Estymowane średnie marginalne (EMMs)
emm2 <- emmeans(m2, ~ site*group)
emm_df2 <- as.data.frame(emm2)  # do wykresu: kolumny emmean, lower.CL, upper.CL

# (5) Kontrasty: PHPT vs kontrola w każdej lokalizacji (tabela do konsoli)
cat("\nPHPT vs control w poszczególnych lokalizacjach:\n")
contr_tbl <- pairs(emmeans(m2, ~ group | site), adjust = "holm")
print(contr_tbl)

# (6) Wykres EMM ±95% CI (punkty + errorbary + linie)
pd <- position_dodge(width = 0.35)

lme_plot2 <- ggplot(emm_df2, aes(x = site, y = emmean, color = group, group = group)) +
  geom_point(size = 3, position = pd) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.14, position = pd) +
  geom_line(alpha = 0.7, position = pd) +
  labs(
    x = "Skeletal site",
    y = "Z-score (estimated marginal means ±95% CI)",
    color = "Group",
    title = "Z-score by skeletal site and group (mixed-effects model with a random intercept for patient)."
  ) +
  theme_minimal(base_size = 12)

ggsave("Lme_plot2.jpg", plot = lme_plot2, width = 9, height = 4, dpi = 300)

```
