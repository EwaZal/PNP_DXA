---
title: "PHPT DXA"
author: "Ewa Zalewska, Lukasz Cieszynski, Monika Berendt - Obolonczyk, Julia Tarnowska, Bartosz Zeglen, Renata Swiatkowska-Stodulska"
date:  "`r format(Sys.time(), '%e %b %Y, godz. %H:%M')`"
output:
  html_document:
    code_folding: hide
---

```{r, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

```{r setup, include=FALSE}

install.packages("Matrix")
library(dplyr)
library(purrr)
library(ggpubr)
library(tidyr)
library(scales)
library(rstatix)
library(ggplot2)
library(ggpubr)
library(ggsignif)
library(mice)
library(lme4)
library(lmerTest)   # wartości p dla lmer
library(emmeans)    # estymowane średnie i kontrasty
library(performance) # diagnostyka



plik_dane_do_analizy <- "PHPT.RDS"

if (file.exists(plik_dane_do_analizy)) {
  PHPT <- readRDS(plik_dane_do_analizy)
} else {
  stop(sprintf("Nie znaleziono pliku: `%s`. Uruchom notatnik przygotowujący zbiór danych!", plik_dane_do_analizy))
}


# Set global theme
theme_set(theme_classic2(base_size = 13))


PHPT_lme <- PHPT

names(PHPT_lme)
```

# algorytm MICE 
``` {r}

kolumny_do_imputacji <- c("TBS", "Tscore_lumbar", "Tscore_femur_neck", "Tscore_radial", "BMD_neck")
dane_subset <- PHPT_lme[, kolumny_do_imputacji]

imputacja <- mice(dane_subset, m = 5, method = 'pmm', seed = 123)

dane_imputowane <- complete(imputacja, 1)

PHPT_lme[, kolumny_do_imputacji] <- dane_imputowane

summary(PHPT_lme)

```

``` {r}
score_lme <- bind_cols(
  PHPT_lme %>%
    select(LUMBAR = Tscore_lumbar, FEMUR = Tscore_femur_neck, RADIAL = Tscore_radial) %>%
    pivot_longer(cols = everything(), names_to = "site", values_to = "Tscore"),
  
  PHPT_lme %>%
    select(zscore_lumbar, zscore_femur_neck, zscore_radial) %>%
    pivot_longer(cols = everything(), names_to = NULL, values_to = "zscore") %>%
    select(zscore),
  
  PHPT_lme %>%
    select(group, sex, age, BMI, id) %>%
    slice(rep(1:n(), each = 3))  # powielamy wiersze x3, bo każdy pacjent ma 3 pomiary
)

```


``` {r}
# MODEL 1: random intercept dla pacjenta
m1 <- lmer(Tscore ~ site*group + age + sex + BMI + (1 | id), data = score_lme)
```
